#!/usr/bin/python
from nao.inspector import Inspector
from nao.fs import FileSystem
from nao.ast import constraint as ir

def test_nm():
    print("\n[*] === nm ===")
    fs = FileSystem('fs-test-nm')
    with open("/vagrant/bugs/nm/CVE-2019-14250/memcorrupt_nm-2.30_gcc-9.1.0_gold") as f:
        fs.create('test.elf', f.read())

    inspector = Inspector("./sample/nm.patched", debug=True)
    name_liblto_plugin_so = 'liblto_plugin.so.0.0.0'
    addr_segv = 0x98F0

    cond = ir.Eq(ir.Variable('reg_98F0_rdi', 8,  addr_segv, ir.Register('rdi'), name_liblto_plugin_so), ir.Value(0))
    print("post condition = {}".format(cond))

    inspector.run(args=["--plugin", "/usr/lib/gcc/x86_64-linux-gnu/7/liblto_plugin.so.0", fs.path('test.elf')], files=fs, env={'LD_LIBRARY_PATH': '/usr/lib/gcc/x86_64-linux-gnu/7'})
    return inspector.collect(cond)

if __name__ == "__main__":
    res = test_nm()
    print(res)
    assert len(res) > 0
